<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precios - AERO SERVICES Venezuela</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Importación de jsPDF y html2canvas para una mejor generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 1rem auto;
            padding: 1.5rem; /* Increased padding for a cleaner look */
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            border: 1px solid #e2e8f0;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem; /* Increased margin */
            padding-bottom: 1rem; /* Increased padding */
            border-bottom: 1px solid #e2e8f0;
        }
        .logo-section {
            display: flex;
            align-items: center;
        }
        .logo {
            width: auto;
            height: 100px; /* Slightly smaller logo for a more formal look */
            margin-right: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo img {
            width: auto;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        /* Slogan for screen display */
        .slogan-on-screen {
            text-align: right;
            font-style: italic;
            color: #4a5568;
            font-size: 1.4rem; /* Slightly smaller for formality */
            line-height: 1.4;
        }
        .slogan-on-screen strong {
            font-weight: 700;
            color: #2c5282;
        }
        /* Slogan for print, hidden by default on screen */
        .slogan-for-print {
            display: none; /* Hidden by default on screen */
            margin-top: 0.5rem;
            font-style: italic;
            font-size: 0.9rem;
            color: #4a5568;
            line-height: 1.4;
        }
        .slogan-for-print strong {
            font-weight: 700;
            color: #2c5282;
        }

        .section-title {
            font-size: 1.6rem; /* Slightly larger for prominence */
            font-weight: 700; /* Bolder */
            color: #2c5282;
            margin-top: 1.5rem; /* Increased top margin */
            margin-bottom: 1rem; /* Increased bottom margin */
            text-align: center;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #2c5282; /* Stronger border for formality */
        }
        .input-group {
            margin-bottom: 1rem; /* Increased margin */
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .input-group label {
            margin-bottom: 0;
            flex-grow: 1;
            margin-right: 0.75rem; /* Increased margin */
            text-align: left;
            font-weight: 600; /* Bolder labels */
            color: #333; /* Darker text for formality */
        }
        .input-group input, .input-group select {
            width: 35%; /* Adjusted width for inputs */
            min-width: 150px; /* Minimum width for readability */
            padding: 0.6rem 0.8rem; /* Increased padding */
            border: 1px solid #a0aec0; /* Darker border for formality */
            border-radius: 8px;
            font-size: 1rem;
            color: #333;
            transition: border-color 0.2s;
            text-align: center;
        }
        /* Adjust input width for smaller screens if needed */
        @media (max-width: 640px) {
            .input-group {
                flex-direction: column;
                align-items: flex-start;
            }
            .input-group label {
                margin-bottom: 0.4rem;
                margin-right: 0;
            }
            .input-group input, .input-group select {
                width: 100%;
                min-width: unset;
                text-align: left;
            }
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #2c5282; /* Darker focus border */
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.2); /* Darker shadow */
        }
        .notes-section {
            margin-top: 1.5rem; /* Increased margin */
            padding-top: 1rem; /* Increased padding */
            border-top: 1px solid #e2e8f0;
            background-color: #ffffff; /* Ensure white background */
        }
        .notes-section h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c5282;
            margin-bottom: 0.75rem;
            text-align: center; /* Center title */
        }
        .notes-section ul {
            list-style: none;
            padding-left: 0;
        }
        .notes-section ul li {
            margin-bottom: 0.5rem;
            color: #4a5568;
            line-height: 1.6; /* Increased line height for readability */
            display: flex;
            align-items: flex-start;
            padding-left: 0.25rem;
            font-size: 0.95rem; /* Slightly larger font */
        }
        .notes-section ul li svg {
            margin-right: 0.5rem;
            flex-shrink: 0;
            margin-top: 0.15rem; /* Adjust icon alignment */
            color: #2c5282; /* Icon color */
        }
        .notes-section ul li span {
            flex-grow: 1;
        }
        .contact-info {
            margin-top: 1.5rem; /* Increased margin */
            padding-top: 1rem; /* Increased padding */
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 0.95rem;
            color: #4a5568;
            background-color: #ffffff; /* Ensure white background */
        }
        .contact-info strong {
            color: #2c5282;
        }
        .error-message {
            color: #e53e3e;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            width: 100%;
            text-align: right;
        }
        @media (max-width: 640px) {
            .error-message {
                text-align: left;
            }
        }
        .scenario-selection {
            margin-bottom: 1.5rem;
            padding: 0.75rem; /* Increased padding */
            background-color: #f7fafc; /* Lighter background */
            border-radius: 8px;
            border: 1px solid #e2e8f0; /* Softer border */
            text-align: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }
        .scenario-selection label {
            margin-right: 1rem; /* Increased margin */
            font-weight: 600;
            color: #2c5282;
            cursor: pointer;
        }
        .scenario-selection input[type="radio"] {
            margin-right: 0.4rem;
            accent-color: #007bff;
        }

        /* Styles for the budget table */
        .budget-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem; /* Increased margin */
            background-color: #ffffff; /* White background for formality */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: none; /* No shadow for formal look */
            border: 1px solid #e2e8f0; /* Subtle border for the whole table */
        }
        .budget-table th, .budget-table td {
            padding: 0.8rem 1rem; /* Increased padding */
            text-align: left;
            border: 1px solid #e2e8f0; /* Borders for all cells */
            color: #000; /* Black text for formality */
        }
        .budget-table th {
            background-color: #f0f4f8; /* Light grey for headers */
            color: #2c5282;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.95rem; /* Slightly larger font */
        }
        .budget-table td {
            font-size: 1rem;
        }
        .budget-table tbody tr:last-child td {
            border-bottom: 1px solid #e2e8f0; /* Ensure last row still has bottom border */
        }
        .budget-table .total-row td {
            background-color: #e0f2fe; /* Light blue for total row */
            font-weight: 700;
            color: #007bff;
            font-size: 1.15rem; /* Slightly larger font for total */
        }
        /* Align numeric columns to the right */
        .budget-table td:nth-child(2),
        .budget-table td:nth-child(3) {
            text-align: right;
        }
        .budget-table .mora-note {
            font-size: 0.85rem;
            color: #e53e3e;
            padding-top: 0.25rem;
            font-style: italic;
            text-align: right;
            border-top: 1px dashed #e2e8f0;
            margin-top: 0.5rem;
            padding-left: 1rem;
            padding-right: 1rem;
            background-color: #ffffff; /* Ensure white background */
            color: #000; /* Black text for formality */
        }
        .summary-section {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #e6f2ff;
            border-radius: 8px;
            border: 1px solid #b3d9ff;
            text-align: center;
            font-weight: 600;
            color: #2c5282;
            font-size: 1.1rem;
        }
        .summary-section .result-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #007bff;
            background-color: #d1e9ff;
            padding: 0.2rem 0.4rem;
            border-radius: 6px;
            display: inline-block;
            margin-left: 0.25rem;
        }

        /* New styles for the admin panel */
        .admin-controls-container {
            max-width: 900px;
            margin: 1rem auto 0.5rem auto;
            padding: 1rem; /* Increased padding */
            background-color: #e0f7fa;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            border: 1px solid #b2ebf2;
            color: #006064;
        }

        .admin-title {
            font-size: 1.2rem; /* Slightly larger */
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            color: #004d40;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #a7d9de;
        }

        .admin-input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .admin-input-group label {
            font-weight: 600;
            margin-right: 0.75rem;
            flex-grow: 1;
        }

        .admin-input-group input {
            width: 40%; /* Adjusted width */
            padding: 0.4rem 0.6rem;
            border: 1px solid #a7d9de;
            border-radius: 6px;
            font-size: 0.95rem;
            color: #333;
            text-align: center;
        }

        /* Styles for the new offer section */
        .offer-section {
            margin-top: 1.5rem;
            padding: 1.5rem; /* Increased padding */
            background-color: #ffffff; /* White background for formality */
            border-radius: 8px;
            border: 1px solid #e2e8f0; /* Subtle border */
            color: #333; /* Darker text */
            box-shadow: none; /* No shadow */
        }
        .offer-section p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #4a5568;
        }
        .offer-section .input-group {
            margin-bottom: 0.8rem; /* Adjusted margin */
            flex-wrap: nowrap; /* Prevent wrapping for labels/inputs */
            align-items: baseline; /* Align text baselines */
        }
        .offer-section .input-group label {
            color: #333; /* Darker label text */
            width: 45%; /* Fixed width for labels */
            flex-shrink: 0; /* Prevent label from shrinking */
            margin-right: 1rem; /* Space between label and input */
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .offer-section .input-group input {
            border-color: #a0aec0; /* Darker border */
            width: 50%; /* Fixed width for inputs */
            text-align: left; /* Align text to left in inputs */
            font-size: 0.95rem;
        }
        /* Style for print spans in offer section */
        .offer-section .input-group span[id^="print"] {
            width: 50%; /* Match input width */
            text-align: right; /* Align values to the right */
            color: #000; /* Black text */
            display: none; /* Hidden by default on screen */
            font-size: 0.95rem;
            font-weight: 500;
        }


        /* Buttons for navigation and actions */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1.2rem; /* Increased gap */
            margin-top: 2rem; /* Increased margin */
        }
        .action-buttons button {
            padding: 0.8rem 1.8rem; /* Increased padding */
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            background-color: #38a169;
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .action-buttons button:hover {
            background-color: #2f855a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* History Page Styles */
        #history-page {
            display: none; /* Hidden by default */
        }
        .history-list {
            margin-top: 1.5rem;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.2rem; /* Increased padding */
            border-bottom: 1px solid #e2e8f0;
            background-color: #f7fafc;
            border-radius: 8px;
            margin-bottom: 0.6rem; /* Increased margin */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-item-details {
            flex-grow: 1;
            color: #4a5568;
            font-size: 0.95rem;
        }
        .history-item-details strong {
            color: #2c5282;
        }
        .history-item .history-actions {
            display: flex;
            gap: 0.75rem; /* Increased space */
        }
        .history-item .history-actions button {
            padding: 0.6rem 1.2rem; /* Adjusted padding */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .history-item .history-actions button:hover {
            background-color: #0056b3;
        }
        .history-item .history-actions .delete-button {
            background-color: #e53e3e;
        }
        .history-item .history-actions .delete-button:hover {
            background-color: #c53030;
        }

        /* Delay Calculation Section */
        #delayCalculationSection {
            margin-top: 2rem; /* Increased margin */
            padding: 1.5rem; /* Increased padding */
            background-color: #ffffff; /* White background for formality */
            border-radius: 12px;
            border: 1px solid #e2e8f0; /* Subtle border */
            color: #333; /* Darker text */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Lighter shadow */
            display: none; /* Hidden by default, shown when a service is selected */
        }
        #delayCalculationSection h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1.2rem;
            color: #2c5282;
            text-align: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        #delayCalculationSection .input-group {
            margin-bottom: 1rem;
        }
        #delayCalculationSection .input-group label {
            color: #333; /* Darker label text */
            font-weight: 600;
        }
        #delayCalculationSection .input-group span {
            color: #000; /* Black text for displayed values */
            font-weight: 500;
        }
        #delayCalculationSection .result-box {
            background-color: #f0f4f8; /* Light grey background */
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            font-weight: 600;
            color: #333; /* Darker text */
            border: 1px solid #e2e8f0; /* Subtle border */
        }
        #delayCalculationSection .result-box span {
            font-weight: 700;
            color: #007bff; /* Blue for key results */
        }
        #delayCalculationSection .print-button {
            padding: 0.75rem 1.5rem;
            background-color: #38a169;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            margin-top: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #delayCalculationSection .print-button:hover {
            background-color: #2f855a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: #333;
        }
        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #2c5282;
        }
        .modal-content p {
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }
        .modal-buttons .confirm-button {
            background-color: #e53e3e;
            color: white;
        }
        .modal-buttons .confirm-button:hover {
            background-color: #c53030;
        }
        .modal-buttons .cancel-button {
            background-color: #cbd5e0;
            color: #4a5568;
        }
        .modal-buttons .cancel-button:hover {
            background-color: #a0aec0;
        }

        /* Print-specific styles for the temporary print container */
        #print-container {
            position: absolute;
            left: -9999px; /* Off-screen */
            top: -9999px;
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            background-color: white;
            padding: 0.5in; /* Standard print margins */
            box-sizing: border-box; /* Include padding in width/height */
            color: #000; /* Ensure black text */
            font-family: 'Inter', sans-serif; /* Ensure font is applied */
            font-size: 11pt; /* Standard print font size */
        }

        /* Styles for elements when they are inside the print-container */
        #print-container .admin-controls-container,
        #print-container .action-buttons,
        #print-container .contact-info p:not(.slogan-for-print p),
        #print-container .input-group input,
        #print-container .input-group select,
        #print-container .error-message,
        #print-container .input-group .text-sm,
        #print-container .scenario-selection,
        #print-container .section-title,
        #print-container .header,
        #print-container .slogan-on-screen,
        #print-container #actualPaymentDate /* Hide actual payment date input in delay report */
        {
            display: none !important;
        }

        #print-container .print-only-budget-header,
        #print-container .print-only-header {
            display: flex !important; /* Show print-only headers */
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #2c5282;
            color: #000;
        }
        #print-container .print-only-budget-header .header-left,
        #print-container .print-only-header .header-left {
            flex-basis: 30%;
            text-align: left;
        }
        #print-container .print-only-budget-header .header-left img,
        #print-container .print-only-header .header-left img {
            height: 70px;
            width: auto;
        }
        #print-container .print-only-budget-header .header-right,
        #print-container .print-only-header .header-right {
            flex-basis: 65%;
            text-align: right;
        }
        #print-container .print-only-budget-header h1,
        #print-container .print-only-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #000 !important;
            margin-bottom: 0.3rem;
        }
        #print-container .print-only-budget-header p,
        #print-container .print-only-header p {
            font-size: 0.9rem;
            color: #000 !important;
            margin-bottom: 0.15rem;
        }
        #print-container .print-only-budget-header span,
        #print-container .print-only-header span {
            color: #000 !important;
        }

        #print-container .offer-section,
        #print-container #delayCalculationSection {
            background-color: white !important;
            border: none !important;
            box-shadow: none !important;
            color: #000 !important;
            padding: 0 !important;
            margin-top: 0 !important;
        }
        #print-container .offer-section p {
            color: #000 !important;
            margin-bottom: 0.4rem;
        }
        #print-container .input-group {
            display: flex;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.2rem;
        }
        #print-container .input-group label {
            flex: 0 0 auto;
            width: 45%;
            margin-right: 0.5rem;
            text-align: left;
            font-weight: 600;
            color: #000 !important;
            font-size: 0.9rem;
        }
        #print-container .input-group span[id^="print"],
        #print-container #delayClientName,
        #print-container #delayClientId,
        #print-container #delayServiceDate,
        #print-container #delayEstimatedPaymentDate,
        #print-container #delayOriginalAmountDue,
        #print-container #calculatedDelayMonths,
        #print-container #additionalInterestAmount,
        #print-container #newTotalWithDelay,
        #print-container #newPricePerHectareWithDelay,
        #print-container #delayDaysCount
        {
            flex: 0 0 auto;
            width: 50%;
            text-align: right;
            color: #000 !important;
            display: block !important; /* Show the span for printing */
            font-size: 0.9rem;
        }

        #print-container .budget-table {
            background-color: white !important;
            box-shadow: none !important;
            border: 1px solid #e2e8f0 !important;
            margin-top: 0.75rem;
        }
        #print-container .budget-table th,
        #print-container .budget-table td {
            color: #000 !important;
            border: 1px solid #e2e8f0 !important;
            background-color: white !important;
            padding: 0.4rem 0.6rem;
            font-size: 0.9rem;
        }
        #print-container .budget-table th {
            background-color: #f0f4f8 !important;
        }
        #print-container .budget-table .total-row td {
            background-color: #e0f2fe !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            font-size: 1rem;
        }
        #print-container .budget-table td:nth-child(2),
        #print-container .budget-table td:nth-child(3) {
            text-align: right !important;
        }
        #print-container .budget-table .mora-note {
            color: #000 !important;
            border-top: 1px dashed #e2e8f0 !important;
            font-size: 0.75rem;
        }

        #print-container .notes-section {
            background-color: white !important;
            border-top: 1px solid #e2e8f0 !important;
            padding-top: 0.5rem;
            margin-top: 0.75rem;
        }
        #print-container .notes-section h2 {
            color: #000 !important;
            text-align: center;
            font-size: 1.1rem;
        }
        #print-container .notes-section ul li {
            color: #000 !important;
            font-size: 0.75rem;
            margin-bottom: 0.2rem;
        }
        #print-container .notes-section ul li svg {
            fill: #000 !important;
            width: 0.8em;
            height: 0.8em;
        }

        #print-container .contact-info {
            display: block !important;
            text-align: center;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
        }
        #print-container .slogan-for-print {
            display: block !important;
            color: #000 !important;
            font-size: 0.8rem !important;
            font-style: italic !important;
            margin-bottom: 0.3rem;
        }
        #print-container .slogan-for-print strong {
            color: #000 !important;
        }
        #print-container .contact-info p {
            font-size: 0.75rem !important;
        }

        #print-container #delayCalculationResults {
            display: block !important; /* Ensure results box is visible for delay report */
            background-color: #f0f4f8 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            border: 1px solid #e2e8f0 !important;
            color: #000 !important;
        }
        #print-container #delayCalculationResults span {
            background-color: transparent !important;
            color: #000 !important; /* Ensure black for delay results values */
        }
        #print-container #delayCalculationResults strong {
            color: #000 !important;
        }
        #print-container #delayCalculationResults .text-sm {
            color: #000 !important;
        }

        /* Standard browser print styles (still useful for direct browser printing) */
        @media print {
            body > * {
                display: none !important; /* Hide everything by default */
            }
            .container {
                display: block !important;
                width: 100%;
                max-width: 100%;
                margin: 0 auto !important;
                padding: 0.5in !important; /* Set consistent margins for print */
                box-shadow: none !important;
                border: none !important;
                background-color: white !important;
                color: #000 !important;
            }
            .admin-controls-container, .action-buttons, .header, .slogan-on-screen, #actualPaymentDate {
                display: none !important;
            }
            .print-only-budget-header, .print-only-header {
                display: flex !important;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
                padding-bottom: 0.75rem;
                border-bottom: 2px solid #2c5282;
            }
            .print-only-budget-header .header-left, .print-only-header .header-left {
                flex-basis: 30%;
                text-align: left;
            }
            .print-only-budget-header .header-left img, .print-only-header .header-left img {
                height: 70px;
                width: auto;
            }
            .print-only-budget-header .header-right, .print-only-header .header-right {
                flex-basis: 65%;
                text-align: right;
            }
            .print-only-budget-header h1, .print-only-header h1 {
                font-size: 1.5rem;
                font-weight: 700;
                color: #000 !important;
                margin-bottom: 0.3rem;
            }
            .print-only-budget-header p, .print-only-header p {
                font-size: 0.9rem;
                color: #000 !important;
                margin-bottom: 0.15rem;
            }
            .print-only-budget-header span, .print-only-header span {
                color: #000 !important;
            }

            .offer-section, #delayCalculationSection {
                background-color: white !important;
                border: none !important;
                box-shadow: none !important;
                color: #000 !important;
                padding: 0 !important;
                margin-top: 0 !important;
            }
            .offer-section p {
                color: #000 !important;
                margin-bottom: 0.4rem;
            }
            .input-group {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between;
                align-items: baseline;
                margin-bottom: 0.2rem;
            }
            .input-group label {
                flex: 0 0 auto;
                width: 45%;
                margin-right: 0.5rem;
                text-align: left;
                font-weight: 600;
                color: #000 !important;
                font-size: 0.9rem;
            }
            .input-group input, .input-group select {
                display: none !important; /* Hide inputs in print */
            }
            .input-group span[id^="print"],
            #delayClientName, #delayClientId, #delayServiceDate, #delayEstimatedPaymentDate, #delayOriginalAmountDue,
            #calculatedDelayMonths, #additionalInterestAmount, #newTotalWithDelay, #newPricePerHectareWithDelay, #delayDaysCount {
                flex: 0 0 auto;
                width: 50%;
                text-align: right;
                color: #000 !important;
                display: block !important; /* Show the span for printing */
                font-size: 0.9rem;
            }

            .budget-table {
                background-color: white !important;
                box-shadow: none !important;
                border: 1px solid #e2e8f0 !important;
                margin-top: 0.75rem;
            }
            .budget-table th, .budget-table td {
                color: #000 !important;
                border: 1px solid #e2e8f0 !important;
                background-color: white !important;
                padding: 0.4rem 0.6rem;
                font-size: 0.9rem;
            }
            .budget-table th {
                background-color: #f0f4f8 !important;
            }
            .budget-table .total-row td {
                background-color: #e0f2fe !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 1rem;
            }
            .budget-table td:nth-child(2), .budget-table td:nth-child(3) {
                text-align: right !important;
            }
            .budget-table .mora-note {
                color: #000 !important;
                border-top: 1px dashed #e2e8f0 !important;
                font-size: 0.75rem;
            }

            .notes-section {
                background-color: white !important;
                border-top: 1px solid #e2e8f0 !important;
                padding-top: 0.5rem;
                margin-top: 0.75rem;
            }
            .notes-section h2 {
                color: #000 !important;
                text-align: center;
                font-size: 1.1rem;
            }
            .notes-section ul li {
                color: #000 !important;
                font-size: 0.75rem;
                margin-bottom: 0.2rem;
            }
            .notes-section ul li svg {
                fill: #000 !important;
                width: 0.8em;
                height: 0.8em;
            }

            .contact-info {
                display: block !important;
                text-align: center;
                margin-top: 0.75rem;
                padding-top: 0.5rem;
                border-top: 1px solid #e2e8f0;
            }
            .slogan-for-print {
                display: block !important;
                color: #000 !important;
                font-size: 0.8rem !important;
                font-style: italic !important;
                margin-bottom: 0.3rem;
            }
            .slogan-for-print strong {
                color: #000 !important;
            }
            .contact-info p {
                font-size: 0.75rem !important;
            }

            #delayCalculationResults {
                display: block !important;
                background-color: #f0f4f8 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border: 1px solid #e2e8f0 !important;
                color: #000 !important;
            }
            #delayCalculationResults span {
                background-color: transparent !important;
                color: #000 !important;
            }
            #delayCalculationResults strong {
                color: #000 !important;
            }
            #delayCalculationResults .text-sm {
                color: #000 !important;
            }

            @page {
                size: Letter;
                margin: 0.5in;
            }
        }
    </style>
</head>
<body>
    <!-- Login/Register Page -->
    <div id="auth-page" class="container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh;">
        <h2 class="section-title">AERO SERVICES Venezuela</h2>
        <div class="logo-section mb-8">
            <div class="logo">
                <img src="https://i.postimg.cc/rw84Gd2y/230823-LOGO-ACTUALIZADO-ASEVENCA-jroc.png" alt="AERO SERVICES Logo">
            </div>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Iniciar Sesión o Registrarse</h3>

        <div class="w-full max-w-md">
            <div class="mb-4">
                <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="tu@ejemplo.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="********">
            </div>
            <div id="auth-error-message" class="text-red-500 text-sm mb-4" style="display: none;"></div>
            <div class="flex items-center justify-between">
                <button id="login-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    Iniciar Sesión
                </button>
                <button id="register-button" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                    Registrarse
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Panel (hidden by default, shown after login) -->
    <div id="admin-panel" class="admin-controls-container" style="display: none;">
        <h2 class="admin-title">Configuración de Precios y Tasas (Solo para Edición)</h2>
        <div class="admin-input-group">
            <label for="adminBase15">Precio Base 15 Lts/Ha (€):</label>
            <input type="number" id="adminBase15" step="0.01" oninput="updateAdminValues()">
        </div>
        <div class="admin-input-group">
            <label for="adminBase20">Precio Base 20 Lts/Ha (€):</label>
            <input type="number" id="adminBase20" step="0.01" oninput="updateAdminValues()">
        </div>
        <div class="admin-input-group">
            <label for="adminBase25">Precio Base 25 Lts/Ha (€):</label>
            <input type="number" id="adminBase25" step="0.01" oninput="updateAdminValues()">
        </div>
        <div class="admin-input-group">
            <label for="adminCommercialRate">Tasa Comercial Anual (%):</label>
            <input type="number" id="adminCommercialRate" step="0.1" oninput="updateAdminValues()">
        </div>
        <div class="admin-input-group">
            <label for="adminHighRate">Tasa Cosecha Anual (%):</label>
            <input type="number" id="adminHighRate" step="0.1" oninput="updateAdminValues()">
        </div>
        <div class="admin-input-group">
            <label for="adminDelayInterestRate">Interés por Retraso Anual (%):</label>
            <input type="number" id="adminDelayInterestRate" step="0.1" oninput="updateAdminValues()">
        </div>
        <div class="scenario-selection">
            <p class="font-semibold mb-2">Seleccione un Escenario de Pago:</p>
            <label>
                <input type="radio" name="scenario" value="contado" checked onchange="handleScenarioChange()"> Pago de Contado
            </label>
            <label>
                <input type="radio" name="scenario" value="financiamiento" onchange="handleScenarioChange()"> Financiamiento (Abono 45%)
            </label>
            <label>
                <input type="radio" name="scenario" value="cosecha" onchange="handleScenarioChange()"> Pago a Final de Cosecha
            </label>
        </div>
    </div>

    <!-- Main Calculator Page (hidden by default, shown after login) -->
    <div id="main-calculator-page" class="container" style="display: none;">
        <header class="header">
            <div class="logo-section">
                <!-- Logo de AERO SERVICES Venezuela -->
                <div class="logo">
                    <img src="https://i.postimg.cc/rw84Gd2y/230823-LOGO-ACTUALIZADO-ASEVENCA-jroc.png" alt="AERO SERVICES Logo">
                </div>
                <!-- Se elimina el nombre de la empresa y el RIF -->
                <div class="company-info">
                    <!-- Contenido oculto -->
                </div>
            </div>
            <div class="slogan-on-screen"> <!-- Slogan for screen display -->
                <p>No fumigamos</p>
                <p><strong>Gestionamos Calidad!</strong></p>
            </div>
        </header>

        <!-- New Print-Only Header for Budget -->
        <div class="print-only-budget-header" style="display: none;">
            <div class="header-left">
                <img src="https://i.postimg.cc/rw84Gd2y/230823-LOGO-ACTUALIZADO-ASEVENCA-jroc.png" alt="AERO SERVICES Logo">
            </div>
            <div class="header-right">
                <h1>Presupuesto de Servicios Aéreos con Drone</h1>
                <p>Fecha de Emisión: <span id="budgetIssueDatePrint"></span></p>
            </div>
        </div>

        <h2 class="section-title">Inversión en Servicios Aéreos con Drone</h2>
        <p class="text-center text-lg font-semibold text-gray-700 mb-6">Presupuesto por Hectárea (Ha.)</p>

        <!-- New Offer Section -->
        <div class="offer-section">
            <p>Por medio del presente, <strong>AERO SERVICES Venezuela</strong> hace entrega de la oferta de servicios de fumigación con las siguientes condiciones:</p>
            <div class="input-group">
                <label for="clientName">Nombre del Cliente:</label>
                <input type="text" id="clientName" placeholder="Ingrese nombre del cliente">
                <span id="printClientName" style="display: none;"></span> <!-- For printing -->
            </div>
            <div class="input-group">
                <label for="clientId">Número de Cédula/RIF:</label>
                <input type="text" id="clientId" placeholder="Ingrese Cédula/RIF">
                <span id="printClientId" style="display: none;"></span> <!-- For printing -->
            </div>
            <div class="input-group">
                <label for="serviceDate">Fecha de Prestación del Servicio:</label>
                <input type="date" id="serviceDate" onchange="handleDateChange()">
                <span id="printServiceDate" style="display: none;"></span> <!-- For printing -->
            </div>
            <div class="input-group">
                <label for="estimatedPaymentDate">Fecha Estimada de Pago del Servicio:</label>
                <input type="date" id="estimatedPaymentDate" onchange="handleDateChange()">
                <span id="printEstimatedPaymentDate" style="display: none;"></span> <!-- For printing -->
            </div>
        </div>

        <div class="input-group">
            <label for="hectares">Hectáreas a Fumigar:</label>
            <input type="number" id="hectares" value="1" min="1" step="1" oninput="calculateCostsAndDisplay()">
            <div id="hectaresError" class="error-message"></div>
            <span id="printHectares" style="display: none;"></span> <!-- For printing -->
        </div>

        <div class="input-group">
            <label for="mixVolume">Volumen de Mezcla (Lts/Ha):</label>
            <select id="mixVolume" onchange="calculateCostsAndDisplay()">
                <option value="15">15 Lts/Ha</option>
                <option value="20">20 Lts/Ha</option>
                <option value="25">25 Lts/Ha</option>
            </select>
            <div id="mixVolumeInfo" class="text-sm text-gray-500 mt-1" style="width: 100%; text-align: right;">Seleccione el volumen de mezcla para determinar el precio base por hectárea.</div>
            <span id="printMixVolume" style="display: none;"></span> <!-- For printing -->
        </div>

        <div class="input-group">
            <label for="financingMonths">Meses para el Pago (desde la prestación del servicio):</label>
            <input type="text" id="financingMonths" value="N/A" readonly>
            <div id="financingMonthsError" class="error-message"></div>
            <div id="financingMonthsInfo" class="text-sm text-gray-500 mt-1" style="width: 100%; text-align: right;">Este es el período en meses hasta el pago único final.</div>
            <span id="printFinancingMonths" style="display: none;"></span> <!-- For printing -->
        </div>

        <div id="resultsTableContainer">
            <!-- La tabla de resultados se generará aquí -->
        </div>

        <div class="notes-section">
            <h2>Consideraciones Importantes:</h2>
            <ul>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 0 0-1.146-1.047l-3.232 3.535-1.992-1.807a.75.75 0 0 0-1.112 1.04l2.62 2.507a.75.75 0 0 0 1.112 0l3.975-4.358Z" clip-rule="evenodd" />
                    </svg>
                    <span>El precio base por hectárea varía según el volumen de mezcla seleccionado.</span>
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 0 0-1.146-1.047l-3.232 3.535-1.992-1.807a.75.75 0 0 0-1.112 1.04l2.62 2.507a.75.75 0 0 0 1.112 0l3.975-4.358Z" clip-rule="evenodd" />
                    </svg>
                    <span>Suministramos la <strong>Nivelación del pH</strong> en el costo de nuestros servicios.</span>
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 0 0-1.146-1.047l-3.232 3.535-1.992-1.807a.75.75 0 0 0-1.112 1.04l2.62 2.507a.75.75 0 0 0 1.112 0l3.975-4.358Z" clip-rule="evenodd" />
                    </svg>
                    <span>Nuestros precios <strong>no incluyen IVA</strong>.</span>
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 0 0-1.146-1.047l-3.232 3.535-1.992-1.807a.75.75 0 0 0-1.112 1.04l2.62 2.507a.75.75 0 0 0 1.112 0l3.975-4.358Z" clip-rule="evenodd" />
                    </svg>
                    <span>Montos aplican para el pago €. En Bolívares, el monto de divisas a cancelar se regirá por la <strong>tasa</strong> del Euro (€) emitida por el Banco Central de Venezuela (BCV) para la fecha del pago.</span>
                </li>
                <li>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 0 0-1.146-1.047l-3.232 3.535-1.992-1.807a.75.75 0 0 0-1.112 1.04l2.62 2.507a.75.75 0 0 0 1.112 0l3.975-4.358Z" clip-rule="evenodd" />
                    </svg>
                    <span>Remita el comprobante de pago a <strong>nuestra</strong> línea de atención al cliente <strong>(0424) 405-4139 vía WhatsApp</strong> y a nuestro email: <strong>aeroservices.vzla@gmail.com</strong> a fin de hacerle llegar su estatus de cuenta.</span>
                </li>
            </ul>
        </div>

        <div class="action-buttons">
            <button onclick="saveService()">Guardar Servicio</button>
            <button onclick="showHistoryPage()">Ver Historial de Servicios</button>
            <button onclick="printBudgetReport()">Imprimir Presupuesto</button> <!-- New print button for budget -->
            <button onclick="signOutUser()">Cerrar Sesión</button>
        </div>

        <footer class="contact-info">
            <div class="slogan-for-print"> <!-- Slogan for print display -->
                <p>No fumigamos</p>
                <p><strong>Gestionamos Calidad!</strong></p>
            </div>
            <p>&copy; 2025 AERO SERVICES Venezuela. Todos los derechos reservados.</p>
            <p id="userIdDisplay" class="text-sm text-gray-400 mt-2"></p>
        </footer>
    </div>

    <!-- History Page -->
    <div id="history-page" class="container" style="display: none;">
        <h2 class="section-title">Historial de Servicios y Cálculo de Retrasos</h2>
        <div id="serviceHistoryList" class="history-list">
            <p class="text-center text-gray-500">Cargando historial de servicios...</p>
        </div>

        <!-- Delay Calculation Section - Now integrated directly into history page -->
        <div id="delayCalculationSection" class="delay-calculation-section">
            <div class="print-only-header" style="display: none;">
                <div style="text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #2c5282;">
                    <h1 style="font-size: 1.8rem; font-weight: 700; color: #2c5282; margin-bottom: 0.5rem;">Reporte de Cálculo de Retraso de Pago</h1>
                    <p style="font-size: 1rem; color: #4a5568;">AERO SERVICES Venezuela</p>
                    <p style="font-size: 0.9rem; color: #666;">Fecha de Emisión: <span id="reportIssueDatePrint"></span></p>
                </div>
            </div>
            <h3>Detalle de Cálculo por Retraso</h3>
            <div class="input-group">
                <label>Cliente:</label>
                <span id="delayClientName"></span>
            </div>
            <div class="input-group">
                <label>Cédula/RIF:</label>
                <span id="delayClientId"></span>
            </div>
            <div class="input-group">
                <label>Fecha de Servicio:</label>
                <span id="delayServiceDate"></span>
            </div>
            <div class="input-group">
                <label>Fecha Estimada de Pago:</label>
                <span id="delayEstimatedPaymentDate"></span>
            </div>
            <div class="input-group">
                <label>Monto Original Adeudado:</label>
                <span id="delayOriginalAmountDue"></span>
            </div>
            <div class="input-group">
                <label for="actualPaymentDate">Fecha Real de Pago:</label>
                <input type="date" id="actualPaymentDate" onchange="calculateDelayInterest()">
            </div>
            <div id="delayCalculationResults" class="result-box" style="display: none;">
                <p>Meses de Retraso Calculados: <span id="calculatedDelayMonths"></span></p>
                <p>Interés Adicional por Retraso: <span id="additionalInterestAmount"></span></p>
                <p><strong>Nuevo Monto Total Adeudado con Retraso: <span id="newTotalWithDelay"></span></strong></p>
                <p><strong>Costo por Hectárea con Retraso (Total): <span id="newPricePerHectareWithDelay"></span></strong></p>
                <!-- Updated note with dynamic days -->
                <p class="text-sm mt-2" id="delayNote">Nota: Se está efectuando un cálculo por retraso de <span id="delayDaysCount"></span> días desde la fecha convenida de pago inicialmente al financiamiento.</p>
            </div>
            <div class="action-buttons mt-4">
                <button onclick="printDelayReport()" id="printReportButton" style="display: none;">Imprimir Reporte</button>
            </div>
        </div>

        <div class="action-buttons">
            <button onclick="showMainCalculatorPage()">Volver a la Calculadora</button>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar Eliminación</h3>
            <p id="modalMessage">¿Estás seguro de que deseas eliminar este servicio?</p>
            <div class="modal-buttons">
                <button class="confirm-button" id="modalConfirmBtn">Sí, Eliminar</button>
                <button class="cancel-button" id="modalCancelBtn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Dedicated print container (hidden off-screen) -->
    <div id="print-container"></div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Global Firebase variables
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        let firebaseInitialized = false;

        // Base prices per hectare based on mix volume
        let BASE_PRICES_BY_MIX_VOLUME = {
            '15': 18.00, // Euros per Hectare for 15 Lts/Ha
            '20': 19.50, // Euros per Hectare for 20 Lts/Ha
            '25': 21.20  // Euros per Hectare for 25 Lts/Ha
        };

        // Standardized annual interest rates (percentage)
        let STANDARD_COMMERCIAL_INTEREST_RATE = 36; // 36% annual for financing with down payment
        let STANDARD_HIGH_INTEREST_RATE = 60;     // 60% annual for payment at harvest end
        let DELAY_INTEREST_RATE = 24; // 24% annual for delay

        const FINANCING_PERCENTAGE = 0.55; // 55% of the cost is financed
        const INITIAL_DEPOSIT_PERCENTAGE = 0.45; // 45% initial deposit

        let currentSelectedService = null; // To hold the service data when calculating delay

        // Function to format currency (always in EUR)
        function formatCurrency(value) {
            return `€ ${value.toFixed(2).replace('.', ',')}`;
        }

        // Function to format dates to dd/mm/yyyy
        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Return original if invalid date

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        window.formatDateToDDMMYYYY = formatDateToDDMMYYYY; // Expose to global scope

        // Function to load values from localStorage
        function loadValuesFromLocalStorage() {
            const storedPrices = localStorage.getItem('BASE_PRICES_BY_MIX_VOLUME');
            const storedCommercialRate = localStorage.getItem('STANDARD_COMMERCIAL_INTEREST_RATE');
            const storedHighRate = localStorage.getItem('STANDARD_HIGH_INTEREST_RATE');
            const storedDelayRate = localStorage.getItem('DELAY_INTEREST_RATE');

            if (storedPrices) {
                BASE_PRICES_BY_MIX_VOLUME = JSON.parse(storedPrices);
            }
            if (storedCommercialRate) {
                STANDARD_COMMERCIAL_INTEREST_RATE = parseFloat(storedCommercialRate);
            }
            if (storedHighRate) {
                STANDARD_HIGH_INTEREST_RATE = parseFloat(storedHighRate);
            }
            if (storedDelayRate) {
                DELAY_INTEREST_RATE = parseFloat(storedDelayRate);
            }
        }

        // Function to save values to localStorage
        function saveValuesToLocalStorage() {
            localStorage.setItem('BASE_PRICES_BY_MIX_VOLUME', JSON.stringify(BASE_PRICES_BY_MIX_VOLUME));
            localStorage.setItem('STANDARD_COMMERCIAL_INTEREST_RATE', STANDARD_COMMERCIAL_INTEREST_RATE);
            localStorage.setItem('STANDARD_HIGH_INTEREST_RATE', STANDARD_HIGH_INTEREST_RATE);
            localStorage.setItem('DELAY_INTEREST_RATE', DELAY_INTEREST_RATE);
        }

        // Function to populate admin inputs with current values
        function populateAdminInputs() {
            document.getElementById('adminBase15').value = BASE_PRICES_BY_MIX_VOLUME['15'];
            document.getElementById('adminBase20').value = BASE_PRICES_BY_MIX_VOLUME['20'];
            document.getElementById('adminBase25').value = BASE_PRICES_BY_MIX_VOLUME['25'];
            document.getElementById('adminCommercialRate').value = STANDARD_COMMERCIAL_INTEREST_RATE;
            document.getElementById('adminHighRate').value = STANDARD_HIGH_INTEREST_RATE;
            document.getElementById('adminDelayInterestRate').value = DELAY_INTEREST_RATE;
        }

        // Function to update values from admin inputs
        function updateAdminValues() {
            BASE_PRICES_BY_MIX_VOLUME['15'] = parseFloat(document.getElementById('adminBase15').value) || BASE_PRICES_BY_MIX_VOLUME['15'];
            BASE_PRICES_BY_MIX_VOLUME['20'] = parseFloat(document.getElementById('adminBase20').value) || BASE_PRICES_BY_MIX_VOLUME['20'];
            BASE_PRICES_BY_MIX_VOLUME['25'] = parseFloat(document.getElementById('adminBase25').value) || BASE_PRICES_BY_MIX_VOLUME['25'];
            STANDARD_COMMERCIAL_INTEREST_RATE = parseFloat(document.getElementById('adminCommercialRate').value) || STANDARD_COMMERCIAL_INTEREST_RATE;
            STANDARD_HIGH_INTEREST_RATE = parseFloat(document.getElementById('adminHighRate').value) || STANDARD_HIGH_INTEREST_RATE;
            DELAY_INTEREST_RATE = parseFloat(document.getElementById('adminDelayInterestRate').value) || DELAY_INTEREST_RATE;

            saveValuesToLocalStorage(); // Save updated values to localStorage
            calculateCostsAndDisplay(); // Call consolidated function
        }
        // Expose function to global scope
        window.updateAdminValues = updateAdminValues;


        // Function to calculate months between two dates
        function calculateMonthsBetweenDates(startDateStr, endDateStr) {
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                return NaN; // Invalid dates
            }

            // Calculate difference in days
            const diffTime = Math.abs(endDate.getTime() - startDate.getTime());
            // Convert milliseconds to days
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            // Convert days to months using the average number of days in a month (30.4375 days per month)
            return diffDays / 30.4375;
        }

        // Function to update financing months field based on dates
        function updateFinancingMonthsBasedOnDates() {
            const serviceDate = document.getElementById('serviceDate').value;
            const estimatedPaymentDate = document.getElementById('estimatedPaymentDate').value;
            const financingMonthsInput = document.getElementById('financingMonths');
            const selectedScenario = document.querySelector('input[name="scenario"]:checked').value;

            if (selectedScenario === 'contado') {
                financingMonthsInput.value = 'N/A';
            } else {
                if (serviceDate && estimatedPaymentDate) {
                    const months = calculateMonthsBetweenDates(serviceDate, estimatedPaymentDate);
                    if (!isNaN(months)) {
                        financingMonthsInput.value = months.toFixed(2); // Display with two decimals for precision
                    } else {
                        financingMonthsInput.value = ''; // Clear if dates are invalid
                    }
                } else {
                    financingMonthsInput.value = ''; // Clear if dates are not set
                }
            }
        }
        // Expose function to global scope
        window.updateFinancingMonthsBasedOnDates = updateFinancingMonthsBasedOnDates;


        // Main cost calculation function
        function calculateCosts() {
            const hectares = parseFloat(document.getElementById('hectares').value);
            const mixVolume = document.getElementById('mixVolume').value;
            // Get financingMonths value, handle 'N/A'
            const financingMonthsValue = document.getElementById('financingMonths').value;
            let financingMonths = parseFloat(financingMonthsValue);

            const basePricePerHa = BASE_PRICES_BY_MIX_VOLUME[mixVolume];

            let isValid = true;
            document.getElementById('hectaresError').textContent = '';
            document.getElementById('financingMonthsError').textContent = '';

            if (isNaN(hectares) || hectares <= 0) {
                document.getElementById('hectaresError').textContent = 'El número de hectáreas debe ser un valor positivo.';
                isValid = false;
            }
            // Only validate financingMonths if it's not 'N/A' and it's a number
            if (financingMonthsValue !== 'N/A' && (isNaN(financingMonths) || financingMonths <= 0)) {
                document.getElementById('financingMonthsError').textContent = 'Los meses para el pago deben ser un número positivo.';
                isValid = false;
            }

            if (!isValid) {
                document.getElementById('resultsTableContainer').innerHTML = '';
                return {}; // Return empty object if inputs are invalid
            }

            const monthlyCommercialRate = (STANDARD_COMMERCIAL_INTEREST_RATE / 100) / 12;
            const monthlyHighRate = (STANDARD_HIGH_INTEREST_RATE / 100) / 12;

            // --- Scenario 1: Cash Payment ---
            const totalContado = basePricePerHa * hectares;

            // --- Scenario 2: Financing (45% Down Payment) ---
            const totalServiceBaseForFinancing = basePricePerHa * hectares;
            const initialDepositAmount = totalServiceBaseForFinancing * INITIAL_DEPOSIT_PERCENTAGE;
            // Use the calculated financingMonths for future value calculation
            const amountToFinance = totalServiceBaseForFinancing * FINANCING_PERCENTAGE;
            const futureValueFinanciamiento = amountToFinance * Math.pow((1 + monthlyCommercialRate), financingMonths);
            const totalFinanciamientoScenario = initialDepositAmount + futureValueFinanciamiento; // Total paid in this scenario

            // --- Scenario 3: Payment at Harvest End ---
            const totalServiceBaseForCosecha = basePricePerHa * hectares;
            // Use the calculated financingMonths for future value calculation
            const futureValueCosecha = totalServiceBaseForCosecha * Math.pow((1 + monthlyHighRate), financingMonths);

            return {
                basePricePerHa: basePricePerHa,
                totalContado: totalContado,
                initialDepositAmount: initialDepositAmount,
                futureValueFinanciamiento: futureValueFinanciamiento,
                totalFinanciamientoScenario: totalFinanciamientoScenario,
                futureValueCosecha: futureValueCosecha,
                hectares: hectares, // Pass hectares for summary calculation
                mixVolume: mixVolume,
                financingMonths: financingMonths // Pass the numeric value
            };
        }
        // Expose function to global scope
        window.calculateCosts = calculateCosts;


        // Function to display only the selected scenario in table format
        function displaySelectedScenario() {
            const calculatedData = calculateCosts();
            const resultsTableContainer = document.getElementById('resultsTableContainer');
            resultsTableContainer.innerHTML = ''; // Clear previous results

            if (Object.keys(calculatedData).length === 0) { // Check if calculations were invalid
                return;
            }

            const { basePricePerHa, totalContado, initialDepositAmount, futureValueFinanciamiento, totalFinanciamientoScenario, futureValueCosecha, hectares } = calculatedData;
            const selectedScenario = document.querySelector('input[name="scenario"]:checked').value;

            let tableHtml = `
                <table class="budget-table">
                    <thead>
                        <tr>
                            <th>Descripción</th>
                            <th>P. Unt. Ha.</th>
                            <th>Monto Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (selectedScenario === 'contado') {
                tableHtml += `
                    <tr>
                        <td>Servicio de Fumigación (Contado)</td>
                        <td>${formatCurrency(totalContado / hectares)}</td>
                        <td>${formatCurrency(totalContado)}</td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>Total a Pagar</strong></td>
                        <td></td>
                        <td><strong>${formatCurrency(totalContado)}</strong></td>
                    </tr>
                `;
            } else if (selectedScenario === 'financiamiento') {
                // Cost per hectare for the initial deposit
                const initialDepositPerHa = basePricePerHa * INITIAL_DEPOSIT_PERCENTAGE;
                // Cost per hectare for the final financed payment (including interest)
                // Ensure futureValueFinanciamiento is a number before division
                const financedPaymentPerHa = (futureValueFinanciamiento && hectares) ? futureValueFinanciamiento / hectares : 0;
                // Sum of costs per hectare for the summary
                const totalCostPerHaFinanced = initialDepositPerHa + financedPaymentPerHa;


                tableHtml += `
                    <tr>
                        <td>Abono Inicial (45%)</td>
                        <td>${formatCurrency(initialDepositPerHa)}</td>
                        <td>${formatCurrency(initialDepositAmount)}</td>
                    </tr>
                    <tr>
                        <td>Pago Final (55% Financiado)</td>
                        <td>${formatCurrency(financedPaymentPerHa)}</td>
                        <td>${formatCurrency(futureValueFinanciamiento)}</td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>Total a Pagar</strong></td>
                        <td><strong>${formatCurrency(totalCostPerHaFinanced)}</strong></td>
                        <td><strong>${formatCurrency(totalFinanciamientoScenario)}</strong></td>
                    </tr>
                `;
                // Add mora note below the table for this scenario
                tableHtml += `
                    <tr>
                        <td colspan="3" class="mora-note">Nota: En caso de mora en el pago final, se aplicarán cargos adicionales.</td>
                    </tr>
                `;

            } else if (selectedScenario === 'cosecha') {
                // Cost per hectare for payment at harvest end (including interest)
                // Ensure futureValueCosecha is a number before division
                const totalCosechaPerHa = (futureValueCosecha && hectares) ? futureValueCosecha / hectares : 0;

                tableHtml += `
                    <tr>
                        <td>Pago Único a Final de Cosecha</td>
                        <td>${formatCurrency(totalCosechaPerHa)}</td>
                        <td>${formatCurrency(futureValueCosecha)}</td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>MONTO ÚNICO A PAGAR AL FINAL DE COSECHA</strong></td>
                        <td></td>
                        <td><strong>${formatCurrency(futureValueCosecha)}</strong></td>
                    </tr>
                `;
                // Add mora note below the table for this scenario
                tableHtml += `
                    <tr>
                        <td colspan="3" class="mora-note">Nota: En caso de mora en el pago, se aplicarán cargos adicionales.</td>
                    </tr>
                `;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;
            resultsTableContainer.innerHTML = tableHtml;

            // Update print-only spans and header date with dd/mm/yyyy format
            document.getElementById('printClientName').textContent = document.getElementById('clientName').value;
            document.getElementById('printClientId').textContent = document.getElementById('clientId').value;
            document.getElementById('printServiceDate').textContent = formatDateToDDMMYYYY(document.getElementById('serviceDate').value);
            document.getElementById('printEstimatedPaymentDate').textContent = formatDateToDDMMYYYY(document.getElementById('estimatedPaymentDate').value);
            document.getElementById('printHectares').textContent = document.getElementById('hectares').value;
            document.getElementById('printMixVolume').textContent = document.getElementById('mixVolume').value;
            document.getElementById('printFinancingMonths').textContent = document.getElementById('financingMonths').value;
            document.getElementById('budgetIssueDatePrint').textContent = formatDateToDDMMYYYY(new Date().toISOString().slice(0,10)); // Current date
        }
        // Expose function to global scope
        window.displaySelectedScenario = displaySelectedScenario;

        // Consolidated function to call when inputs change
        function calculateCostsAndDisplay() {
            updateFinancingMonthsBasedOnDates(); // Update months first
            // No need to call calculateCosts here, it's called by displaySelectedScenario
            displaySelectedScenario(); // Then calculate costs and display the scenario
        }
        window.calculateCostsAndDisplay = calculateCostsAndDisplay;

        // Handler for date changes
        function handleDateChange() {
            calculateCostsAndDisplay();
        }
        window.handleDateChange = handleDateChange;

        // Handler for scenario changes
        function handleScenarioChange() {
            calculateCostsAndDisplay();
        }
        window.handleScenarioChange = handleScenarioChange;


        // --- Firebase Functions ---
        async function saveService() {
            if (!firebaseInitialized) {
                showCustomMessage("Para guardar servicios, por favor, configura tu API Key de Firebase en el código HTML.");
                return;
            }

            if (!window.db || !window.userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                showCustomMessage("Error: Firebase no está listo o el usuario no está autenticado. Por favor, recarga la página o verifica tu conexión.");
                return;
            }

            const clientName = document.getElementById('clientName').value;
            const clientId = document.getElementById('clientId').value;
            const serviceDate = document.getElementById('serviceDate').value;
            const estimatedPaymentDate = document.getElementById('estimatedPaymentDate').value;
            const calculatedData = calculateCosts();
            const selectedScenario = document.querySelector('input[name="scenario"]:checked').value;
            const financingMonthsValue = document.getElementById('financingMonths').value; // Get the displayed value

            if (!clientName || !clientId || !serviceDate || !estimatedPaymentDate || Object.keys(calculatedData).length === 0) {
                showCustomMessage("Por favor, completa todos los campos de la oferta y realiza un cálculo antes de guardar.");
                return;
            }

            let totalAmountToPay = 0;
            let amountDueForPayment = 0; // New field for the amount subject to delay interest
            let initialPaymentMade = 0; // New field to store the initial payment for delay calculation

            if (selectedScenario === 'contado') {
                totalAmountToPay = calculatedData.totalContado;
                amountDueForPayment = calculatedData.totalContado; // Full amount for cash
                initialPaymentMade = 0; // No initial payment for cash
            } else if (selectedScenario === 'financiamiento') {
                totalAmountToPay = calculatedData.totalFinanciamientoScenario;
                amountDueForPayment = calculatedData.futureValueFinanciamiento; // Only the financed portion
                initialPaymentMade = calculatedData.initialDepositAmount; // Initial deposit for financing
            } else if (selectedScenario === 'cosecha') {
                totalAmountToPay = calculatedData.futureValueCosecha;
                amountDueForPayment = calculatedData.futureValueCosecha; // Full amount for harvest
                initialPaymentMade = 0; // No initial payment for harvest
            }

            const serviceRecord = {
                clientName: clientName,
                clientId: clientId,
                serviceDate: serviceDate,
                estimatedPaymentDate: estimatedPaymentDate,
                hectares: calculatedData.hectares,
                mixVolume: calculatedData.mixVolume,
                financingMonths: financingMonthsValue, // Save the displayed value ('N/A' or number)
                selectedScenario: selectedScenario,
                totalAmount: totalAmountToPay, // Overall total for the scenario
                amountDueForPayment: amountDueForPayment, // Amount specifically for delay interest calculation
                initialPaymentMade: initialPaymentMade, // Store initial payment
                timestamp: new Date().toISOString()
            };

            try {
                // Determine appId based on whether running in Canvas or locally with user config
                const currentAppId = window.firebaseApp ? window.firebaseApp.options.projectId : 'default-fumigation-app-id';
                console.log("Attempting to save service for userId:", window.userId, "in appId:", currentAppId);
                const docRef = await addDoc(collection(window.db, `artifacts/${currentAppId}/users/${window.userId}/serviceRecords`), serviceRecord);
                showCustomMessage("Servicio guardado con éxito. ID: " + docRef.id);
                console.log("Service saved successfully with ID:", docRef.id);
                // Clear form or provide feedback
            } catch (e) {
                console.error("Error adding document: ", e);
                showCustomMessage("Error al guardar el servicio: " + e.message);
            }
        }
        // Expose function to global scope
        window.saveService = saveService;


        async function fetchServiceHistory() {
            if (!firebaseInitialized) {
                document.getElementById('serviceHistoryList').innerHTML = '<p class="text-center text-red-500">Para ver el historial, por favor, configura tu API Key de Firebase en el código HTML.</p>';
                return;
            }

            if (!window.db || !window.userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                document.getElementById('serviceHistoryList').innerHTML = '<p class="text-center text-red-500">Error: No se pudo cargar el historial. Firebase no está listo o no autenticado.</p>';
                return;
            }

            const historyListDiv = document.getElementById('serviceHistoryList');
            historyListDiv.innerHTML = '<p class="text-center text-gray-500">Cargando historial...</p>';
            console.log("Attempting to fetch service history for userId:", window.userId);

            try {
                const currentAppId = window.firebaseApp ? window.firebaseApp.options.projectId : 'default-fumigation-app-id';
                const q = query(collection(window.db, `artifacts/${currentAppId}/users/${window.userId}/serviceRecords`), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                let historyHtml = '';

                if (querySnapshot.empty) {
                    historyHtml = '<p class="text-center text-gray-500">No hay servicios guardados aún.</p>';
                    console.log("No service records found for userId:", window.userId);
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        historyHtml += `
                            <div class="history-item">
                                <div class="history-item-details">
                                    <strong>Cliente:</strong> ${data.clientName} (${data.clientId})<br>
                                    <strong>Fecha Servicio:</strong> ${formatDateToDDMMYYYY(data.serviceDate)}<br>
                                    <strong>Monto Total:</strong> ${formatCurrency(data.totalAmount)} (${data.selectedScenario})<br>
                                    <strong>Meses para el Pago:</strong> ${data.financingMonths}
                                </div>
                                <div class="history-actions">
                                    <button onclick="selectServiceForDelayCalculation('${doc.id}')">Calcular Retraso</button>
                                    <button class="delete-button" onclick="deleteService('${doc.id}', '${data.clientName}')">Eliminar</button>
                                </div>
                            </div>
                        `;
                    });
                    console.log(`Fetched ${querySnapshot.size} service records for userId:`, window.userId);
                }
                historyListDiv.innerHTML = historyHtml;
            } catch (e) {
                console.error("Error fetching documents: ", e);
                historyListDiv.innerHTML = `<p class="text-center text-red-500">Error al cargar el historial: ${e.message}</p>`;
            }
        }
        // Expose function to global scope
        window.fetchServiceHistory = fetchServiceHistory;


        async function selectServiceForDelayCalculation(serviceId) {
            if (!firebaseInitialized) {
                showCustomMessage("Para calcular retrasos, por favor, configura tu API Key de Firebase en el código HTML.");
                return;
            }

            if (!window.db || !window.userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                showCustomMessage("Error: Firebase no está listo. Por favor, recarga la página.");
                return;
            }

            try {
                const currentAppId = window.firebaseApp ? window.firebaseApp.options.projectId : 'default-fumigation-app-id';
                const docRef = doc(window.db, `artifacts/${currentAppId}/users/${window.userId}/serviceRecords`, serviceId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentSelectedService = { id: docSnap.id, ...docSnap.data() };

                    // Populate fields in the delay calculation section
                    document.getElementById('delayClientName').textContent = currentSelectedService.clientName;
                    document.getElementById('delayClientId').textContent = currentSelectedService.clientId;
                    document.getElementById('delayServiceDate').textContent = formatDateToDDMMYYYY(currentSelectedService.serviceDate);
                    document.getElementById('delayEstimatedPaymentDate').textContent = formatDateToDDMMYYYY(currentSelectedService.estimatedPaymentDate);
                    document.getElementById('delayOriginalAmountDue').textContent = formatCurrency(currentSelectedService.amountDueForPayment);
                    document.getElementById('reportIssueDatePrint').textContent = formatDateToDDMMYYYY(new Date().toISOString().slice(0,10)); // Current date

                    // Show the delay calculation section
                    document.getElementById('delayCalculationSection').style.display = 'block';
                    document.getElementById('delayCalculationResults').style.display = 'none'; // Hide results until calculated
                    document.getElementById('actualPaymentDate').value = ''; // Clear previous date
                    document.getElementById('printReportButton').style.display = 'none'; // Hide print button initially

                    // Scroll to the delay calculation section
                    document.getElementById('delayCalculationSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

                    // Prompt for actual payment date
                    showCustomMessageWithInput("Por favor, introduce la fecha real de pago para calcular el retraso:", "date", (actualPaymentDate) => {
                        if (actualPaymentDate) {
                            // Now that we have the actual payment date, calculate and display
                            calculateDelayInterest(actualPaymentDate);
                        } else {
                            showCustomMessage("Cálculo de retraso cancelado. No se proporcionó la fecha real de pago.");
                            document.getElementById('delayCalculationSection').style.display = 'none'; // Hide section if cancelled
                        }
                    });

                } else {
                    showCustomMessage("No se encontró el servicio.");
                }
            } catch (e) {
                console.error("Error fetching service for delay calculation: ", e);
                showCustomMessage("Error al cargar el servicio para cálculo de retraso: " + e.message);
            }
        }
        // Expose function to global scope
        window.selectServiceForDelayCalculation = selectServiceForDelayCalculation;


        function calculateDelayInterest(actualPaymentDateStr) {
            if (!currentSelectedService) {
                showCustomMessage("Error interno: No hay servicio seleccionado para calcular el retraso.");
                return;
            }

            if (!actualPaymentDateStr) {
                document.getElementById('delayCalculationResults').style.display = 'none';
                document.getElementById('printReportButton').style.display = 'none';
                return;
            }

            const estimatedDate = new Date(currentSelectedService.estimatedPaymentDate);
            const actualDate = new Date(actualPaymentDateStr);

            let diffDays = 0;
            let delayMonths = 0;
            let additionalInterest = 0;
            let newTotalDueWithDelay = currentSelectedService.amountDueForPayment;
            let overallTotalCostWithDelay = currentSelectedService.initialPaymentMade + newTotalDueWithDelay;
            let newPricePerHectare = overallTotalCostWithDelay / currentSelectedService.hectares;

            if (actualDate > estimatedDate) {
                diffDays = Math.abs(actualDate - estimatedDate) / (1000 * 60 * 60 * 24); // Exact days difference
                delayMonths = diffDays / 30.4375; // Convert days to months
                const monthlyDelayRate = (DELAY_INTEREST_RATE / 100) / 12;
                additionalInterest = currentSelectedService.amountDueForPayment * monthlyDelayRate * delayMonths;
                newTotalDueWithDelay = currentSelectedService.amountDueForPayment + additionalInterest;
                overallTotalCostWithDelay = currentSelectedService.initialPaymentMade + newTotalDueWithDelay;
                newPricePerHectare = overallTotalCostWithDelay / currentSelectedService.hectares;
            }

            document.getElementById('actualPaymentDate').value = actualPaymentDateStr; // Set the input field
            document.getElementById('calculatedDelayMonths').textContent = delayMonths.toFixed(2);
            document.getElementById('additionalInterestAmount').textContent = formatCurrency(additionalInterest);
            document.getElementById('newTotalWithDelay').textContent = formatCurrency(newTotalDueWithDelay);
            document.getElementById('newPricePerHectareWithDelay').textContent = formatCurrency(newPricePerHectare);
            document.getElementById('delayDaysCount').textContent = diffDays.toFixed(0); // Update the days in the note
            document.getElementById('delayCalculationResults').style.display = 'block';
            document.getElementById('printReportButton').style.display = 'inline-block'; // Show print button
        }
        // Expose function to global scope
        window.calculateDelayInterest = calculateDelayInterest;

        // Function to print the delay report using jsPDF
        async function printDelayReport() {
            // Set the current date for the report print header
            document.getElementById('reportIssueDatePrint').textContent = formatDateToDDMMYYYY(new Date().toISOString().slice(0,10));

            const printContainer = document.getElementById('print-container');
            const delaySection = document.getElementById('delayCalculationSection');

            // Clone the delay section
            const clonedSection = delaySection.cloneNode(true);

            // Modify the cloned content for printing
            clonedSection.style.display = 'block'; // Ensure the cloned section is visible

            // Hide input field in the clone
            const actualPaymentDateInput = clonedSection.querySelector('#actualPaymentDate');
            if (actualPaymentDateInput) {
                actualPaymentDateInput.style.display = 'none';
            }

            // Show print-only header in the clone
            const printOnlyHeader = clonedSection.querySelector('.print-only-header');
            if (printOnlyHeader) {
                printOnlyHeader.style.display = 'block';
            }

            // Hide action buttons in the clone
            const actionButtons = clonedSection.querySelector('.action-buttons');
            if (actionButtons) {
                actionButtons.style.display = 'none';
            }

            // Append the cloned section to the off-screen print container
            printContainer.innerHTML = ''; // Clear previous content
            printContainer.appendChild(clonedSection);

            try {
                const canvas = await html2canvas(printContainer, { scale: 1.5, useCORS: true, logging: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save('Reporte_Retraso_Servicio.pdf');
            } catch (error) {
                console.error("Error generating PDF for delay report:", error);
                showCustomMessage("Error al generar el PDF del reporte de retraso: " + error.message);
            } finally {
                // Clean up: remove the cloned section from the print container
                if (clonedSection.parentNode === printContainer) {
                    printContainer.removeChild(clonedSection);
                }
                showHistoryPage(); // Return to history page view
            }
        }
        window.printDelayReport = printDelayReport;

        // Function to print the budget report using jsPDF
        async function printBudgetReport() {
            // Set the current date for the budget print header
            document.getElementById('budgetIssueDatePrint').textContent = formatDateToDDMMYYYY(new Date().toISOString().slice(0,10));

            // Set the values for the print-only spans in the offer section
            document.getElementById('printClientName').textContent = document.getElementById('clientName').value;
            document.getElementById('printClientId').textContent = document.getElementById('clientId').value;
            document.getElementById('printServiceDate').textContent = formatDateToDDMMYYYY(document.getElementById('serviceDate').value);
            document.getElementById('printEstimatedPaymentDate').textContent = formatDateToDDMMYYYY(document.getElementById('estimatedPaymentDate').value);
            document.getElementById('printHectares').textContent = document.getElementById('hectares').value;
            document.getElementById('printMixVolume').textContent = document.getElementById('mixVolume').value;
            document.getElementById('printFinancingMonths').textContent = document.getElementById('financingMonths').value;

            const printContainer = document.getElementById('print-container');
            const mainCalculatorPage = document.getElementById('main-calculator-page');

            // Clone the main calculator page
            const clonedPage = mainCalculatorPage.cloneNode(true);

            // Modify the cloned content for printing
            clonedPage.style.display = 'block'; // Ensure the cloned page is visible

            // Hide elements not needed for the budget print in the clone
            const elementsToHideInClone = clonedPage.querySelectorAll('.admin-controls-container, .action-buttons, .contact-info p:not(.slogan-for-print p), .input-group input, .input-group select, .error-message, .input-group .text-sm, .scenario-selection, .section-title, .header, .slogan-on-screen');
            elementsToHideInClone.forEach(el => {
                el.style.display = 'none';
            });

            // Show print-only header in the clone
            const printOnlyBudgetHeader = clonedPage.querySelector('.print-only-budget-header');
            if (printOnlyBudgetHeader) {
                printOnlyBudgetHeader.style.display = 'flex';
            }

            // Ensure print spans are visible in the clone
            const printSpans = clonedPage.querySelectorAll('[id^="print"]');
            printSpans.forEach(span => {
                span.style.display = 'block';
            });

            // Apply specific print styles to labels in the cloned offer section
            const labelsInClone = clonedPage.querySelectorAll('.offer-section .input-group label, .input-group label');
            labelsInClone.forEach(label => {
                label.style.width = '45%';
                label.style.textAlign = 'left';
                label.style.fontWeight = '600';
                label.style.color = '#000';
                label.style.fontSize = '0.9rem';
            });


            // Append the cloned page to the off-screen print container
            printContainer.innerHTML = ''; // Clear previous content
            printContainer.appendChild(clonedPage);

            try {
                const canvas = await html2canvas(printContainer, { scale: 1.5, useCORS: true, logging: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                pdf.save('Presupuesto_Servicios.pdf');
            } catch (error) {
                console.error("Error generating PDF for budget report:", error);
                showCustomMessage("Error al generar el PDF del presupuesto: " + error.message);
            } finally {
                // Clean up: remove the cloned page from the print container
                if (clonedPage.parentNode === printContainer) {
                    printContainer.removeChild(clonedPage);
                }
                showMainCalculatorPage(); // Return to main calculator view
            }
        }
        window.printBudgetReport = printBudgetReport;


        // --- Page Navigation ---
        function showMainCalculatorPage() {
            document.getElementById('main-calculator-page').style.display = 'block';
            document.getElementById('history-page').style.display = 'none';
            document.getElementById('delayCalculationSection').style.display = 'none'; // Hide delay section when returning
            document.getElementById('admin-panel').style.display = 'block'; // Show admin panel
        }
        // Expose function to global scope
        window.showMainCalculatorPage = showMainCalculatorPage;


        async function showHistoryPage() {
            document.getElementById('main-calculator-page').style.display = 'none';
            document.getElementById('history-page').style.display = 'block';
            document.getElementById('delayCalculationSection').style.display = 'none'; // Hide delay section initially when showing history
            document.getElementById('admin-panel').style.display = 'none'; // Hide admin panel
            await fetchServiceHistory(); // Load history when showing the page
        }
        // Expose function to global scope
        window.showHistoryPage = showHistoryPage;

        // --- Custom Modal Functions ---
        let onConfirmCallback = null;
        let onInputCallback = null; // New callback for input modal

        function showConfirmModal(message, onConfirm) {
            document.getElementById('modalTitle').textContent = "Confirmar Acción"; // Default title for confirmation
            document.getElementById('modalMessage').textContent = message;
            onConfirmCallback = onConfirm;
            document.getElementById('modalConfirmBtn').style.display = 'inline-block'; // Show confirm button
            document.getElementById('modalCancelBtn').textContent = 'Cancelar'; // Reset cancel button text
            document.getElementById('confirmModalOverlay').style.display = 'flex';

            // Hide input field if it was previously shown
            const modalInput = document.getElementById('modalInput');
            if (modalInput) {
                modalInput.style.display = 'none';
                modalInput.value = ''; // Clear value
            }
        }

        // New function for modal with input
        function showCustomMessageWithInput(message, inputType, onInputConfirm) {
            document.getElementById('modalTitle').textContent = "Entrada Requerida";
            document.getElementById('modalMessage').textContent = message;
            onInputCallback = onInputConfirm; // Set the input callback

            let modalInput = document.getElementById('modalInput');
            if (!modalInput) {
                // Create input element if it doesn't exist
                modalInput = document.createElement('input');
                modalInput.setAttribute('id', 'modalInput');
                modalInput.className = 'w-full p-2 border border-gray-300 rounded-md mt-4 mb-4 text-center';
                document.querySelector('.modal-content').insertBefore(modalInput, document.querySelector('.modal-buttons'));
            }
            modalInput.setAttribute('type', inputType);
            modalInput.style.display = 'block';
            modalInput.value = ''; // Clear value

            document.getElementById('modalConfirmBtn').style.display = 'inline-block';
            document.getElementById('modalCancelBtn').textContent = 'Cancelar';
            document.getElementById('confirmModalOverlay').style.display = 'flex';
        }
        window.showCustomMessageWithInput = showCustomMessageWithInput; // Expose to global scope


        function hideConfirmModal() {
            document.getElementById('confirmModalOverlay').style.display = 'none';
            onConfirmCallback = null; // Clear the callback
            onInputCallback = null; // Clear the input callback
            const modalInput = document.getElementById('modalInput');
            if (modalInput) {
                modalInput.style.display = 'none'; // Hide input field
                modalInput.value = ''; // Clear value
            }
        }

        // Attach event listeners for modal buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modalConfirmBtn').addEventListener('click', () => {
                if (onConfirmCallback) {
                    onConfirmCallback();
                } else if (onInputCallback) {
                    const inputVal = document.getElementById('modalInput').value;
                    onInputCallback(inputVal);
                }
                hideConfirmModal();
            });

            document.getElementById('modalCancelBtn').addEventListener('click', () => {
                hideConfirmModal();
            });
        });

        // Function to show a simple message (replaces alert)
        function showCustomMessage(message) {
            document.getElementById('modalTitle').textContent = "Información";
            document.getElementById('modalMessage').textContent = message;
            onConfirmCallback = null; // No action on confirm for simple messages
            onInputCallback = null; // No input action for simple messages
            document.getElementById('modalConfirmBtn').style.display = 'none'; // Hide confirm button
            document.getElementById('modalCancelBtn').textContent = 'Cerrar'; // Change cancel to close
            document.getElementById('confirmModalOverlay').style.display = 'flex';

            // Hide input field if it was previously shown
            const modalInput = document.getElementById('modalInput');
            if (modalInput) {
                modalInput.style.display = 'none';
                modalInput.value = ''; // Clear value
            }
        }
        window.showCustomMessage = showCustomMessage; // Expose to global scope

        // --- Delete Service Function ---
        async function deleteService(serviceId, clientName) {
            if (!firebaseInitialized) {
                showCustomMessage("Para eliminar servicios, por favor, configura tu API Key de Firebase en el código HTML.");
                return;
            }

            showConfirmModal(`¿Estás seguro de que deseas eliminar el servicio de ${clientName}? Esta acción no se puede deshacer.`, async () => {
                if (!window.db || !window.userId) {
                    console.error("Firebase is not initialized or user is not authenticated.");
                    showCustomMessage("Error: Firebase no está listo. Por favor, recarga la página.");
                    return;
                }
                try {
                    const currentAppId = window.firebaseApp ? window.firebaseApp.options.projectId : 'default-fumigation-app-id';
                    console.log("Attempting to delete service with ID:", serviceId, "for userId:", window.userId);
                    await deleteDoc(doc(window.db, `artifacts/${currentAppId}/users/${window.userId}/serviceRecords`, serviceId));
                    showCustomMessage(`Servicio de ${clientName} eliminado con éxito.`);
                    console.log("Service deleted successfully.");
                    fetchServiceHistory(); // Refresh the list
                }
                catch (e) {
                    console.error("Error removing document: ", e);
                    showCustomMessage("Error al eliminar el servicio: " + e.message);
                }
            });
        }
        window.deleteService = deleteService; // Expose to global scope


        // --- Authentication Functions ---
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authErrorMessage = document.getElementById('auth-error-message');
            authErrorMessage.style.display = 'none';

            if (!email || !password) {
                authErrorMessage.textContent = 'Por favor, ingresa tu correo y contraseña.';
                authErrorMessage.style.display = 'block';
                return;
            }

            try {
                await signInWithEmailAndPassword(window.auth, email, password);
                // User will be redirected by onAuthStateChanged
            } catch (error) {
                console.error("Error during login:", error);
                let errorMessage = 'Error al iniciar sesión. Verifica tu correo y contraseña.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuario no encontrado. Por favor, regístrate o verifica tu correo.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contraseña incorrecta.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Correo electrónico inválido.';
                }
                authErrorMessage.textContent = errorMessage;
                authErrorMessage.style.display = 'block';
            }
        }

        async function handleRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authErrorMessage = document.getElementById('auth-error-message');
            authErrorMessage.style.display = 'none';

            if (!email || !password) {
                authErrorMessage.textContent = 'Por favor, ingresa un correo y una contraseña.';
                authErrorMessage.style.display = 'block';
                return;
            }
            if (password.length < 6) {
                authErrorMessage.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                authErrorMessage.style.display = 'block';
                return;
            }

            try {
                await createUserWithEmailAndPassword(window.auth, email, password);
                showCustomMessage("Registro exitoso. ¡Bienvenido!");
                // User will be redirected by onAuthStateChanged
            } catch (error) {
                console.error("Error during registration:", error);
                let errorMessage = 'Error al registrar el usuario.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este correo electrónico ya está en uso.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Correo electrónico inválido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'La contraseña es demasiado débil.';
                }
                authErrorMessage.textContent = errorMessage;
                authErrorMessage.style.display = 'block';
            }
        }

        async function signOutUser() {
            try {
                await signOut(window.auth);
                console.log("User signed out.");
                // Redirect to login page
                document.getElementById('auth-page').style.display = 'flex';
                document.getElementById('admin-panel').style.display = 'none';
                document.getElementById('main-calculator-page').style.display = 'none';
                document.getElementById('history-page').style.display = 'none';
                window.userId = null; // Clear user ID
                document.getElementById('userIdDisplay').textContent = ''; // Clear display
                showCustomMessage("Has cerrado sesión.");
            } catch (error) {
                console.error("Error signing out:", error);
                showCustomMessage("Error al cerrar sesión: " + error.message);
            }
        }
        window.signOutUser = signOutUser; // Expose to global scope


        // Initial setup on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // =================================================================================================
            // === FIREBASE CONFIGURATION: IMPORTANT! REPLACE WITH YOUR OWN VALUES ===
            // =================================================================================================
            // If you want the service history to be persistently saved,
            // paste your Firebase project configuration object here.
            // You can find it in the Firebase console: Project settings -> Your apps -> SDK setup and configuration.
            //
            // EXAMPLE (DO NOT USE THESE VALUES, THEY ARE FOR REFERENCE ONLY):
            // const userFirebaseConfig = {
            //     apiKey: "AIzaSyC...",
            //     authDomain: "your-project.firebaseapp.com",
            //     projectId: "your-project",
            //     storageBucket: "your-project.appspot.com",
            //     messagingSenderId: "1234567890",
            //     appId: "1:234567890:web:abcdef123456",
            //     measurementId: "G-XXXXXXXXXX" // Optional, if you use Google Analytics
            // };
            //
            // If you don't paste your configuration here, the application will work, but the service history will NOT be saved.
            // =================================================================================================
            const userFirebaseConfig = {
                // 👇 Paste your Firebase 'apiKey' here, **between the quotes**.
                apiKey: "AIzaSyB5y_JSgvZZhhF2lblA3Xf-4CHkq4c4Dd8",
                // 👇 Paste your Firebase 'authDomain' here, **between the quotes**.
                authDomain: "calculadora-de-servicios-9d144.firebaseapp.com",
                // 👇 Paste your Firebase 'projectId' here, **between the quotes**.
                projectId: "calculadora-de-servicios-9d144",
                // 👇 Paste your Firebase 'storageBucket' here, **between the quotes**.
                storageBucket: "calculadora-de-servicios-9d144.firebasestorage.app",
                // 👇 Paste your Firebase 'appId' here, **between the quotes**.
                appId: "1:782870922497:web:10b36c6ad335728f944700",
                measurementId: "G-2M7V4M3BSL" // If you have 'measurementId', paste it here too, **between the quotes**.
            };
            // =================================================================================================
            // === IMPORTANT: ENABLE EMAIL/PASSWORD AUTHENTICATION IN YOUR FIREBASE PROJECT ===
            // Go to Firebase Console -> Authentication -> Sign-in method and enable "Email/Password".
            // =================================================================================================


            // Determine which Firebase config to use
            let firebaseConfigToUse = {};
            let isRunningInCanvas = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}';

            if (isRunningInCanvas) {
                // If in Canvas environment, use Canvas-provided config
                firebaseConfigToUse = JSON.parse(__firebase_config);
                console.log("Using Canvas-provided Firebase config (from __firebase_config).");
            } else if (userFirebaseConfig.apiKey && userFirebaseConfig.projectId) {
                // If user provided a valid config in the code, use it
                firebaseConfigToUse = userFirebaseConfig;
                console.log("Using user-provided Firebase config (from userFirebaseConfig).");
            } else {
                // If no Canvas or user config, Firebase will not be initialized
                console.warn("Firebase config not found. Firestore features will be disabled.");
            }

            // Initialize Firebase only if we have a valid config
            if (Object.keys(firebaseConfigToUse).length > 0 && firebaseConfigToUse.apiKey) {
                try {
                    window.firebaseApp = initializeApp(firebaseConfigToUse);
                    window.db = getFirestore(window.firebaseApp);
                    window.auth = getAuth(window.firebaseApp);
                    firebaseInitialized = true; // Set flag to true
                    console.log("Firebase initialized successfully.");

                    onAuthStateChanged(window.auth, async (user) => {
                        if (user) {
                            window.userId = user.uid;
                            console.log("Authenticated user ID:", window.userId);
                            document.getElementById('auth-page').style.display = 'none';
                            showMainCalculatorPage(); // Show main app if authenticated
                        } else {
                            console.log("No user authenticated. Showing login page.");
                            document.getElementById('auth-page').style.display = 'flex';
                            document.getElementById('admin-panel').style.display = 'none';
                            document.getElementById('main-calculator-page').style.display = 'none';
                            document.getElementById('history-page').style.display = 'none';
                            window.userId = null; // Ensure userId is null if not authenticated
                        }
                        // Display the user ID on the page for debugging
                        const userIdDisplay = document.getElementById('userIdDisplay');
                        if (userIdDisplay && window.userId) {
                            userIdDisplay.textContent = `ID de Usuario: ${window.userId}`;
                        } else if (userIdDisplay) {
                            userIdDisplay.textContent = `ID de Usuario: No autenticado`;
                        }

                        loadValuesFromLocalStorage();
                        populateAdminInputs();
                        calculateCostsAndDisplay(); // Initial call to set up the display
                    });
                } catch (error) {
                    console.error("Error initializing Firebase (top level catch):", error);
                    showCustomMessage("Error al inicializar Firebase. Por favor, verifica tu configuración y la conexión a internet.");
                    firebaseInitialized = false; // Ensure flag is false on error
                    // Even if Firebase fails, ensure the UI is in a consistent state
                    document.getElementById('auth-page').style.display = 'flex';
                    document.getElementById('admin-panel').style.display = 'none';
                    document.getElementById('main-calculator-page').style.display = 'none';
                    document.getElementById('history-page').style.display = 'none';
                    window.userId = crypto.randomUUID(); // Fallback to random ID for local operations if Firebase fails
                    const userIdDisplay = document.getElementById('userIdDisplay');
                    if (userIdDisplay) {
                        userIdDisplay.textContent = `ID de Usuario: ${window.userId} (No persistente)`;
                    }
                    loadValuesFromLocalStorage();
                    populateAdminInputs();
                    calculateCostsAndDisplay(); // Initial call
                }
            } else {
                // If Firebase is not initialized, ensure userId has a value for the rest of the app
                window.userId = crypto.randomUUID();
                console.log("Firebase not initialized. Using random user ID for local operations.");
                // Display the user ID on the page for debugging
                const userIdDisplay = document.getElementById('userIdDisplay');
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID de Usuario: ${window.userId} (No persistente)`;
                }
                // Show main calculator if Firebase is not initialized (no auth required)
                document.getElementById('auth-page').style.display = 'none';
                showMainCalculatorPage();
                loadValuesFromLocalStorage();
                populateAdminInputs();
                calculateCostsAndDisplay(); // Initial call
            }

            // Attach event listeners for login/register buttons
            document.getElementById('login-button').addEventListener('click', handleLogin);
            document.getElementById('register-button').addEventListener('click', handleRegister);
        });
    </script>
</body>
</html>
